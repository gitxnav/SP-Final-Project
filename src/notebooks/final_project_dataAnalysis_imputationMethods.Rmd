---
title: "Final Project - Data Analysis - Imputation Methods"
author: "Marco Russo"
date: "January 23, 2026"
output:
  pdf_document: default
  html_document:
    df_print: paged
email: ..
header-includes:
- \usepackage{xcolor}
- \usepackage{framed}
- \usepackage{listings}
---

# Objective

Based on the information extracted from [nhs.uk/conditions/kidney-disease](https://www.nhs.uk/conditions/kidney-disease/) the **Chronic Kidney Disease** (CKD) is a long-term condition where damaged kidneys can't effectively filter waste and extra fluid from the blood. It leading to buildup and potential health problems like heart disease, anemia, and high blood pressure, with diabetes and hypertension being leading causes. Often showing few symptoms until advanced stages, requiring lifestyle changes, medications, or, in severe cases, dialysis or transplant to manage its progression.

There are usually no **symptoms of CKD** in the early stages. It may only be diagnosed if you have a blood or urine test for another reason and the results show a possible problem with your kidneys. At a more advanced stage, symptoms can include:

-   tiredness
-   swollen ankles, feet or hands
-   shortness of breath
-   feeling sick
-   blood in your pee (urine)

The Chronic kidney disease is **usually caused by other conditions** that put a strain on the kidneys. Often it's the result of a combination of different problems. CKD can be caused by:

-   high blood pressure – over time, this can put strain on the small blood vessels in the kidneys and stop the kidneys working properly
-   diabetes – too much glucose in your blood can damage the tiny filters in the kidneys
-   high cholesterol – this can cause a build-up of fatty deposits in the blood vessels supplying your kidneys, which can make it harder for them to work properly
-   kidney infections
-   glomerulonephritis – kidney inflammation
-   autosomal dominant polycystic kidney disease – an inherited condition where growths called cysts develop in the kidneys
-   blockages in the flow of urine – for example, from kidney stones that keep coming back, or an enlarged prostate
-   long-term, regular use of certain medicines – such as lithium and non-steroidal anti-inflammatory drugs (NSAIDs)

CKD **can be diagnosed** using blood and urine tests. These tests look for high levels of certain substances in the blood and urine that are signs your kidneys are not working properly.

If the person at a high risk of developing kidney disease (for example, it has a known risk factor such as high blood pressure or diabetes), he may be advised to have regular tests to check for CKD so it's found at an early stage.

The results of the blood and urine tests can be used to tell the stage of your kidney disease. This is a number that reflects how severe the damage to your kidneys is, with a higher number indicating more serious CKD.

There's **no cure for CKD**, but treatment can help relieve the symptoms and stop it getting worse. The treatment will depend on how severe the condition is. The main treatments are:

-   lifestyle changes to help you remain as healthy as possible
-   medicine to control associated problems such as high blood pressure and high cholesterol
-   medicine that can help the kidneys keep working for longer
-   dialysis – treatment to replicate some of the kidney's functions (this may be necessary in advanced CKD)
-   kidney transplant – this may also be necessary in advanced CKD

CKD can range from a mild condition with no or few symptoms, to a very serious condition where the kidneys stop working, sometimes called kidney failure.

Most people with CKD will be able to control their condition with medicine and regular check-ups. CKD only progresses to kidney failure in around 2 in 100 people with the condition.

If someone has CKD, even if it's mild, he's at an increased risk of developing other serious problems, such as cardiovascular disease. This is a group of conditions affecting the heart and blood vessels, which includes heart attack and stroke.

Cardiovascular disease is one of the main causes of death in people with kidney disease, although healthy lifestyle changes and medicine can help reduce your risk of developing it.

***


# 1. Research questions

1.  **How do blood markers (creatinine, urea, hemoglobin) correlate with kidney disease progression?**
2.  **Which combination of features best predicts CKD status?**
3.  **Are there distinct patient clusters based on their biochemical profiles?**
4.  **How do demographic factors (age, hypertension, diabetes) interact with biochemical markers?**

------------------------------------------------------------------------


# 2. Dataset loading

The dataset has been downloaded from [PubMed Central](https://pmc.ncbi.nlm.nih.gov/articles/PMC8757418/) and this study has been replicated to study improvements[^1].

[^1]V. Kumar et al., “The Indian Chronic Kidney Disease (ICKD) study: baseline characteristics,” Clin Kidney J, vol. 15, no. 1, pp. 60–69, Jan. 2022, doi: 10.1093/CKJ/SFAB149.
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readr)
setwd('/Volumes/HHD_iMac_Storage/URV/SCIENTIFIC_PROGRAMMING/FINAL/SP-Final-Project')
ckd_data <- read_csv("data/raw/chronic_kindey_disease.csv")
```

```{r}
summary(ckd_data)
```

```{r}
head(ckd_data)
```

**Attribute Information**

## Data Set Information:

We use the following representation to collect the dataset:-

* age - age
* bp - blood pressure
* sg - specific gravity
* al - albumin
* su - sugar
* rbc - red blood cells
* pc - pus cell
* pcc - pus cell clumps
* ba - bacteria
* bgr - blood glucose random
* bu - blood urea
* sc - serum creatinine
* sod - sodium
* pot - potassium
* hemo - hemoglobin
* pcv - packed cell volume
* wc - white blood cell count
* rc - red blood cell count
* htn - hypertension
* dm - diabetes mellitus
* cad - coronary artery disease
* appet - appetite
* pe - pedal edema
* ane - anemia
* class - class


**Additional Feature Details**

## Attribute Information:

We use 24 + class = 25 ( 11 numeric ,14 nominal)

    Age(numerical) - age in years
    Blood Pressure(numerical) - bp in mm/Hg
    Specific Gravity(nominal) - sg - (1.005,1.010,1.015,1.020,1.025)
    Albumin(nominal) - al - (0,1,2,3,4,5)
    Sugar(nominal) - su - (0,1,2,3,4,5)
    Red Blood Cells(nominal) - rbc - (normal,abnormal)
    Pus Cell (nominal) - pc - (normal,abnormal)
    Pus Cell clumps(nominal) - pcc - (present,notpresent)
    Bacteria(nominal) - ba - (present,notpresent)
    Blood Glucose Random(numerical) - bgr in mgs/dl
    Blood Urea(numerical) -bu in mgs/dl
    Serum Creatinine(numerical) - sc in mgs/dl
    Sodium(numerical) - sod in mEq/L
    Potassium(numerical) - pot in mEq/L
    Hemoglobin(numerical) - hemo in gms
    Packed Cell Volume(numerical)
    White Blood Cell Count(numerical) - wc in cells/cumm
    Red Blood Cell Count(numerical) - rc in millions/cmm
    Hypertension(nominal) - htn - (yes,no)
    Diabetes Mellitus(nominal) - dm - (yes,no)
    Coronary Artery Disease(nominal) - cad - (yes,no)
    Appetite(nominal) - appet - (good,poor)
    Pedal Edema(nominal) - pe - (yes,no)
    Anemia(nominal) - ane - (yes,no)
    Class (nominal)- class - (ckd,notckd)

**Acknowledgements**

https://archive.ics.uci.edu/ml/datasets/Chronic_Kidney_Disease

***

# 3. Setup and Data Loading

```{r setup, warning=FALSE, message=FALSE}
# Load required libraries
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("corrplot")) install.packages("corrplot")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("gridExtra")) install.packages("gridExtra")
if (!require("caret")) install.packages("caret")
if (!require("mice")) install.packages("mice")
if (!require("dplyr")) install.packages("dplyr")
if (!require("tidyr")) install.packages("tidyr")
if (!require("lattice")) install.packages("lattice")
library(tidyverse)
library(corrplot)
library(ggplot2)
library(gridExtra)
library(caret)
library(mice)
library(dplyr)
library(tidyr)
library(lattice)

if (!require("GGally")) install.packages("GGally")
if (!require("VIM")) install.packages("VIM")
if (!require("psych")) install.packages("psych")
if (!require("car")) install.packages("car")
if (!require("factoextra")) install.packages("factoextra")
if (!require("pROC")) install.packages("pROC")
if (!require("ggpubr")) install.packages("ggpubr")
if (!require("rstatix")) install.packages("rstatix")
library(GGally)
library(VIM)
library(psych)
library(lmtest)
library(car)
library(factoextra)
library(pROC)
library(ggpubr)
library(rstatix)
```




```{r}
# Set seed for reproducibility
set.seed(17)

# Read data
setwd('/Volumes/HHD_iMac_Storage/URV/SCIENTIFIC_PROGRAMMING/FINAL/SP-Final-Project')
ckd_data <- read.table("data/raw/chronic_kindey_disease.csv", 
                       sep = ",", 
                       header = TRUE, 
                       na.strings = c("?", "NA", ""),
                       stringsAsFactors = FALSE)

# Set column names based on dataset description
col_names <- c("age", "bp", "sg", "al", "su", "rbc", "pc", "pcc", "ba", "bgr",
               "bu", "sc", "sod", "pot", "hemo", "pcv", "wbcc", "rbcc",
               "htn", "dm", "cad", "appet", "pe", "ane", "status")

names(ckd_data) <- col_names

# Check structure
str(ckd_data)

```

------------------------------------------------------------------------

## 4. Data cleaning


```{r}
ckd_data %>%
  summarise(across(everything(), ~ sum(is.na(.)))) 
```

```{r}
library(naniar)
library(ggplot2)
# Visualize missing values by variable
gg_miss_var(ckd_data, show_pct = TRUE) +
  labs(title = "Missing Values by Variable in CKD Dataset Subset",
       x = "Variables",
       y = "Proportion of Missing Values")
```

```{r}
library(VIM)

aggr(ckd_data, numbers = TRUE, prop = FALSE, sortVar = TRUE)
```

```{r}
table(ckd_data$rbcc)
```



```{r data_cleaning}
# Display first few rows with original character format
head(ckd_data)

# Function to clean and convert numeric columns
clean_numeric <- function(x) {
  # Remove any non-numeric characters except decimal points and minus signs
  x_clean <- gsub("[^0-9.-]", "", x)
  # Convert to numeric
  as.numeric(x_clean)
}

# Identify numeric and factor columns based on dataset description
numeric_cols <- c("age", "bp", "bgr", "bu", "sc", "sod", "pot", 
                  "hemo", "pcv", "wbcc", "rbcc", "sg", "al", "su")

factor_cols <- c("sg", "al", "su", "rbc", "pc", "pcc", "ba", 
                 "htn", "dm", "cad", "appet", "pe", "ane", "status")

# Apply cleaning
ckd_clean <- ckd_data

# Clean numeric columns
for(col in numeric_cols) {
  ckd_clean[[col]] <- clean_numeric(ckd_clean[[col]])
}

# Clean factor columns with appropriate levels
factor_levels <- list(
  sg = c(1.005, 1.010, 1.015, 1.020, 1.025),
  al = c(0.0, 1.0, 2.0, 3.0, 4.0, 5.0),
  su = c(0.0, 1.0, 2.0, 3.0, 4.0, 5.0),
  rbc = c("normal", "abnormal"),
  pc = c("normal", "abnormal"),
  pcc = c("present", "notpresent"),
  ba = c("present", "notpresent"),
  htn = c("yes", "no"),
  dm = c("yes", "no"),
  cad = c("yes", "no"),
  appet = c("good", "poor"),
  pe = c("yes", "no"),
  ane = c("yes", "no"),
  status = c("ckd", "notckd")
)

for(col in factor_cols) {
  ckd_clean[[col]] <- clean_factor(ckd_clean[[col]], factor_levels[[col]])
}

# Check the cleaned data structure
str(ckd_clean)

# Summary statistics
summary(ckd_clean)

# Check missing values
missing_summary <- sapply(ckd_clean, function(x) sum(is.na(x)))
missing_df <- data.frame(
  Column = names(missing_summary),
  Missing_Count = missing_summary,
  Missing_Percent = round(missing_summary/nrow(ckd_clean)*100, 2)
) %>%
  arrange(desc(Missing_Count))

print("Missing Value Summary:")
print(missing_df)
```

```{r}
# Add binary outcome variable
ckd_clean$status_binary <- ifelse(ckd_clean$status == "ckd", 1, 0)

# Check cleaned structure
cat("\nCleaned Data Structure:\n")
str(ckd_clean)

# Summary statistics
cat("\nSummary Statistics:\n")
summary(ckd_clean)
```



```{r missing_analysis}
## Missing Data Analysis and Imputation


# Calculate missingness
missing_summary <- data.frame(
  Variable = names(ckd_clean),
  Missing_Count = colSums(is.na(ckd_clean)),
  Missing_Percent = round(colSums(is.na(ckd_clean))/nrow(ckd_clean)*100, 2)
) %>%
  arrange(desc(Missing_Percent))

print("Missing Data Summary:")
print(missing_summary)

# Visualize missing data pattern
missing_plot <-  aggr(ckd_clean, 
                     col = c('navyblue', 'red'), 
                     numbers = TRUE, 
                     sortVars = TRUE,
                     labels = names(ckd_clean), 
                     cex.axis = .7,
                     gap = 3, 
                     ylab = c("Missing data pattern", "Pattern"))
```


```{r}
# Multiple imputation using MICE
cat("\nPerforming Multiple Imputation...\n")
imputed_data <- mice(ckd_clean, 
                     m = 5, 
                     maxit = 50, 
                     method = 'pmm', 
                     seed = 42)

# Extract first imputed dataset
ckd_imputed <- complete(imputed_data, 1)

# Check imputation quality
cat("\nMissing values after imputation:", sum(is.na(ckd_imputed)), "\n")
```

```{r}
summary(ckd_clean)
```


```{r}
summary(ckd_imputed)
```

### Imputation by `logreg`




```{r}
setwd('/Volumes/HHD_iMac_Storage/URV/SCIENTIFIC_PROGRAMMING/FINAL/SP-Final-Project')
write_csv(ckd_imputed, "data/processed/dataset_mice_imputed.csv",
          progress = show_progress())
```
```{r}
null_values <- colSums(is.na(ckd_imputed))
print(null_values)
```




