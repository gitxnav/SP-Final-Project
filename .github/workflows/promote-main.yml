name: Promote to Main

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      version:
        description: 'Version tag for release'
        required: true
      dry-run:
        description: 'Dry run (no actual merge)'
        type: boolean
        default: false

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check develop status
      run: |
        echo "Checking if develop is ready for promotion..."
        # Add any validation checks here
        # e.g., check if tests are passing on develop
    
    - name: Create Pull Request to Main
      if: github.event.inputs.dry-run == 'false'
      uses: repo-sync/pull-request@v2
      with:
        source_branch: "develop"
        destination_branch: "main"
        pr_title: "Release ${{ github.event.inputs.version }}"
        pr_body: "Automated promotion from develop to main"
        github_token: ${{ secrets.GITHUB_TOKEN }}
    
  test-main:
    needs: validate
    runs-on: ubuntu-latest
    if: github.event.inputs.dry-run == 'false'
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: main
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"  # Use your production Python version
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run production tests
      run: |
        python -m pytest tests/ --tb=short
    
    - name: Create Release Tag
      if: success()
      run: |
        git config --global user.name 'github-actions'
        git config --global user.email 'github-actions@github.com'
        git tag -a v${{ github.event.inputs.version }} -m "Release v${{ github.event.inputs.version }}"
        git push origin v${{ github.event.inputs.version }}